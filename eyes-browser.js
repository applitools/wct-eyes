/* eslint-disable */

/**
 * @param {string=} query A query string to parse.
 * @return {!Object<string, !Array<string>>} All params on the URL's query.
 */
function getParams(query) {
  query = typeof query === 'string' ? query : window.location.search;
  if (query.substring(0, 1) === '?') {
    query = query.substring(1);
  }
  // python's SimpleHTTPServer tacks a `/` on the end of query strings :(
  if (query.slice(-1) === '/') {
    query = query.substring(0, query.length - 1);
  }
  if (query === '') return {};
  var result = {};
  query.split('&')
    .forEach(function (part) {
      var pair = part.split('=');
      if (pair.length !== 2) {
        console.warn('Invalid URL query part:', part);
        return;
      }
      var key = decodeURIComponent(pair[0]);
      var value = decodeURIComponent(pair[1]);
      if (!result[key]) {
        result[key] = [];
      }
      result[key].push(value);
    });
  return result;
}

/**
 * @param {string} param The param to return a value for.
 * @return {?string} The first value for `param`, if found.
 */
function getParam(param) {
  var params = getParams();
  return params[param] ? params[param][0] : null;
}

/**
 * @param {string} path The URI of the script to load.
 * @param {function} done
 */
function loadScript(path, done) {
  console.debug('WctEyes: loadScript() - begin', path);
  var script = document.createElement('script');
  script.src = path;
  if (done) {
    script.onload = done.bind(null, null);
    script.onerror = done.bind(null, 'Failed to load script ' + script.src);
  }
  document.head.appendChild(script);
}

/**
 * A socket for communication between the CLI and browser runners.
 *
 * @param {string} browserId An ID generated by the CLI runner.
 * @param {!io.Socket} socket The socket.io `Socket` to communicate over.
 */
var CLISocket = /** @class */ (function () {
  var SOCKETIO_ENDPOINT = window.location.protocol + '//' + window.location.host;
  var SOCKETIO_LIBRARY = SOCKETIO_ENDPOINT + '/socket.io/socket.io.js';
  console.debug('WctEyes: CLISocket() - define', SOCKETIO_ENDPOINT, SOCKETIO_LIBRARY);

  function CLISocket(browserId, socket) {
    console.debug('WctEyes: CLISocket() - create', browserId);
    this.browserId = browserId;
    this.socket = socket;
  }

  /**
   * @param {string} event The name of the event to fire.
   * @param {*} data Additional data to pass with the event.
   */
  CLISocket.prototype.emitEvent = function (event, data) {
    console.debug('WctEyes: CLISocket.emitEvent() - begin', event, data);
    this.socket.emit('client-event', {
      browserId: this.browserId,
      event: event,
      data: data
    });
  };

  /**
   * Builds a `CLISocket` if we are within a CLI-run environment; short-circuits
   * otherwise.
   *
   * @param {function(*, CLISocket)} done Node-style callback.
   */
  CLISocket.init = function (done) {
    var browserId = getParam('cli_browser_id');
    console.debug('WctEyes: CLISocket.init() - begin', browserId);
    if (!browserId) return done();

    function openSocket() {
      console.debug('WctEyes: CLISocket.init() - openSocket');
      var socket = io(SOCKETIO_ENDPOINT);
      socket.on('error', function (error) {
        console.debug('WctEyes: CLISocket.init() - error');
        socket.off();
        done(error);
      });

      socket.on('connect', function () {
        console.debug('WctEyes: CLISocket.init() - connect');
        socket.off();
        done(null, new CLISocket(browserId, socket));
      });
    }

    if (typeof io !== 'undefined') {
      openSocket();
    } else {
      loadScript(SOCKETIO_LIBRARY, function (error) {
        console.debug('WctEyes: CLISocket.init() - loadScript done', error);
        if (error) return done(error);
        openSocket();
      });
    }
  };
  return CLISocket;
}());


/**
 *
 */
var EyesEmitter = /** @class */ (function () {
  function EyesEmitter() {
    console.debug('WctEyes: EyesEmitter() - create');
    this.events = {};
  }

  EyesEmitter.prototype.on = function (eventName, fn) {
    console.debug('WctEyes: EyesEmitter.on() - begin', eventName);
    if (typeof this.events[eventName] !== 'object') {
      this.events[eventName] = [];
    }

    this.events[eventName].push(fn);
  };

  EyesEmitter.prototype.off = function (eventName, fn) {
    console.debug('WctEyes: EyesEmitter.off() - begin', eventName);
    if (typeof this.events[eventName] === 'object') {
      var idx = this.events[eventName].indexOf(fn);

      if (idx > -1) {
        this.events[eventName].splice(idx, 1);
      }
    }
  };

  EyesEmitter.prototype.once = function (eventName, fn) {
    console.debug('WctEyes: EyesEmitter.once() - begin', eventName);
    this.on(eventName, function g () {
      this.off(eventName, g);
      fn.apply(this, arguments);
    });
  };

  EyesEmitter.prototype.emit = function (eventName) {
    console.debug('WctEyes: EyesEmitter.emit() - begin', eventName);
    var args = [].slice.call(arguments, 1);

    if (typeof this.events[eventName] === 'object') {
      var events = this.events[eventName];
      for (var i = 0, l = events.length; i < l; i++) {
        events[i].apply(this, args);
      }
    }
  };

  window.EyesEmitter = EyesEmitter;
  return EyesEmitter;
}());


/**
 *
 */
var Eyes = /** @class */ (function () {
  function Eyes() {
    var that = this;
    console.debug('WctEyes: constructor() - begin');
    this.eyesEmitter = window.eyesEmitter = new parent.EyesEmitter();

    this.sessionId = undefined;
    this.socket = undefined;
    this.socketPromise = new Promise(function (resolve, reject) {
      console.debug('WctEyes: constructor() - socket promise');
      CLISocket.init(function (error, socket) {
        if (error) return reject(error);

        that.socket = socket;
        console.debug('WctEyes: constructor() - socket created');
        resolve();
      });
    });

    console.debug('WctEyes: constructor() - end');
    this.controlFlow = undefined;
  }

  /**
   * @param [appName]
   * @param [testName]
   */
  Eyes.prototype.open = function (appName, testName) {
    var that = this;
    console.debug('WctEyes: open() - begin');
    this.controlFlow = this.socketPromise.then(function () {
      return new Promise(function (resolve) {
        console.debug('WctEyes: open() - begin promise');
        that.eyesEmitter.once('eyes:openDone', function (sessionData) {
          console.debug('WctEyes: open() - openDone', sessionData);
          that.sessionId = sessionData.sessionId;
          resolve();
        });
        console.debug('WctEyes: open() - open');
        that.socket.emitEvent('eyes:open', { appName: appName, testName: testName });
      });
    });
    return this.controlFlow;
  };

  /**
   * @param {string} [name]
   */
  Eyes.prototype.checkWindow = function (name) {
    var that = this;
    console.debug('WctEyes: checkWindow() - begin');
    this.controlFlow = this.controlFlow.then(function () {
      return new Promise(function (resolve) {
        console.debug('WctEyes: checkWindow() - begin promise');
        that.eyesEmitter.once('eyes:checkWindowDone', function () {
          console.debug('WctEyes: checkWindow() - checkWindowDone');
          resolve();
        });
        console.debug('WctEyes: checkWindow() - checkWindow');
        that.socket.emitEvent('eyes:checkWindow', { sessionId: that.sessionId, name: name });
      });
    });

    return this.controlFlow;
  };

  Eyes.prototype.close = function (throwEx) {
    var that = this;
    console.debug('WctEyes: close() - begin');
    this.controlFlow = this.controlFlow.then(function () {
      return new Promise(function (resolve, reject) {
        console.debug('WctEyes: close() - begin promise');
        that.eyesEmitter.once('eyes:closeDone', function (testResults) {
          console.debug('WctEyes: close() - closeDone', testResults);
          if (testResults.passed) return resolve();
          return reject(new Error(testResults.message));
        });
        console.debug('WctEyes: close() - close');
        that.socket.emitEvent('eyes:close', { sessionId: that.sessionId, throwEx: throwEx });
      });
    });
    return this.controlFlow;
  };

  Eyes.prototype.abortIfNotClosed = function () {
    console.debug('WctEyes: abortIfNotClosed() - begin');
    if (this.sessionId) {
      var that = this;
      this.controlFlow = new Promise(function (resolve) {
        console.debug('WctEyes: abortIfNotClosed() - begin promise');
        that.eyesEmitter.once('eyes:abortIfNotClosedDone', function () {
          console.debug('WctEyes: abortIfNotClosed() - abortIfNotClosedDone');
          resolve();
        });
        console.debug('WctEyes: abortIfNotClosed() - abortIfNotClosed');
        that.socket.emitEvent('eyes:abortIfNotClosed', { sessionId: that.sessionId });
      });
      return this.controlFlow;
    }
  };

  /**
   * @param {function} callback
   */
  Eyes.prototype.whenDone = function (callback) {
    console.debug('WctEyes: whenDone() - begin');
    if (callback) {
      console.debug('WctEyes: whenDone() - in callback');
      this.controlFlow.then(callback, callback);
    }

    return this.controlFlow;
  };

  window.Eyes = Eyes;
  return Eyes;
}());
